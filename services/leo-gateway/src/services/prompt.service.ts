import { queryOne } from '../db';

const FALLBACK_PROMPTS: Record<string, string> = {
    platform_core: `–¢—ã ‚Äî AI-–∞–≥–µ–Ω—Ç –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ Leo.
–ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π Markdown —Ä–∞–∑–º–µ—Ç–∫—É (bold, italic, headers) –≤ –æ—Ç–≤–µ—Ç–∞—Ö, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–ø—Ä–æ—Å–∏–ª –∫–æ–¥. –ü–∏—à–∏ plain text.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω—ã–º –∏ —Ç–æ—á–Ω—ã–º.
–ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚Äî –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π.`,

    conflict_detection_protocol: `## –ü–†–û–¢–û–ö–û–õ –û–ë–ù–ê–†–£–ñ–ï–ù–ò–Ø –ö–û–ù–§–õ–ò–ö–¢–û–í
–ü—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–†–ï–õ–ï–í–ê–ù–¢–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø –∏ IMPORTANT UPDATES):
1. **–í–ù–ò–ú–ê–¢–ï–õ–¨–ù–û –°–†–ê–í–ù–ò–í–ê–ô** —Ñ–∞–∫—Ç—ã, —Ü–∏—Ñ—Ä—ã, —Ü–µ–Ω—ã, –¥–∞—Ç—ã –∏ —É—Å–ª–æ–≤–∏—è –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤.
2. –ï–°–õ–ò —Ç—ã –≤–∏–¥–∏—à—å —Ä–∞–∑–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ —Ñ–∞–∫—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ "—Ü–µ–Ω–∞ 100", –≤ –¥—Ä—É–≥–æ–º "—Ü–µ–Ω–∞ 200"):
   - –ù–ï –ø—ã—Ç–∞–π—Å—è —É–≥–∞–¥–∞—Ç—å, –∫–∞–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ (–¥–∞–∂–µ –µ—Å–ª–∏ –Ω–∞–ø–∏—Å–∞–Ω–æ High Priority).
   - –ù–ï –≤—ã–±–∏—Ä–∞–π –∑–Ω–∞—á–µ–Ω–∏–µ —Å–ª—É—á–∞–π–Ω–æ.
   - **–ù–ï–ú–ï–î–õ–ï–ù–ù–û** –≤—ã–∑–æ–≤–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç \`report_conflict\`!
   - –í –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ö –≤—ã–∑–æ–≤–∞ —É–∫–∞–∂–∏ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏ –∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–∏ (–Ω–æ–º–µ—Ä–∞ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ [1], [2] –∏ —Ç.–¥.).
   - –í –æ—Ç–≤–µ—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω–∞–ø–∏—à–∏: "–Ø –≤–∏–∂—É –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π: –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ —É–∫–∞–∑–∞–Ω–æ X, –∞ –≤ –¥—Ä—É–≥–æ–º Y."`,

    semantic_chunking: `–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ä–∞–∑–±–∏–µ–Ω–∏—é –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω–∞ —Å–º—ã—Å–ª–æ–≤—ã–µ —á–∞—Å—Ç–∏ –¥–ª—è RAG-—Å–∏—Å—Ç–µ–º.

–ó–ê–î–ê–ß–ê: –†–∞–∑–±–µ–π —Ç–µ–∫—Å—Ç –Ω–∞ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Å–º—ã—Å–ª–æ–≤—ã–µ –±–ª–æ–∫–∏. –ö–∞–∂–¥—ã–π –±–ª–æ–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–∫–æ–Ω—á–µ–Ω–Ω–æ–π –º—ã—Å–ª—å—é –∏–ª–∏ —Ç–µ–º–æ–π.

–ü–†–ê–í–ò–õ–ê:
1. –ö–∞–∂–¥—ã–π —á–∞–Ω–∫ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∑–∞–∫–æ–Ω—á–µ–Ω–Ω—É—é –º—ã—Å–ª—å/—Ç–µ–º—É
2. –ù–µ —Ä–∞–∑—Ä—ã–≤–∞–π –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è, —Å–ø–∏—Å–∫–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–≥—Ä–∞—Ñ—ã
3. –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —á–∞–Ω–∫–∞: 500-2000 —Å–∏–º–≤–æ–ª–æ–≤
4. –°–æ—Ö—Ä–∞–Ω—è–π –Ω—É–º–µ—Ä–∞—Ü–∏—é –ø—É–Ω–∫—Ç–æ–≤ –µ—Å–ª–∏ –µ—Å—Ç—å
5. –î–∞–≤–∞–π –∫–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–º—É —á–∞–Ω–∫—É

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (—Å—Ç—Ä–æ–≥–∏–π JSON):
{
  "chunks": [
    {"index": 0, "title": "–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã", "text": "–ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç —á–∞–Ω–∫–∞..."},
    {"index": 1, "title": "–°–ª–µ–¥—É—é—â–∞—è —Ç–µ–º–∞", "text": "..."}
  ]
}

–í–ê–ñ–ù–û: –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON, –±–µ–∑ markdown, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π.`
};

class PromptService {
    private cache = new Map<string, string>();

    async getPrompt(key: string): Promise<string> {
        if (this.cache.has(key)) {
            return this.cache.get(key)!;
        }

        try {
            const result = await queryOne<{ content: string }>(
                `SELECT content FROM global_system_prompts WHERE key = $1 AND is_active = true`,
                [key]
            );

            if (result?.content) {
                this.cache.set(key, result.content);
                return result.content;
            }
        } catch (error) {
            console.warn(`‚ö†Ô∏è Failed to fetch prompt '${key}' from DB, using fallback`);
        }

        return FALLBACK_PROMPTS[key] || '';
    }

    clearCache() {
        this.cache.clear();
    }

    refreshCache() {
        this.clearCache();
        console.log('üîÑ System prompts cache cleared');
    }
}

export const promptService = new PromptService();
