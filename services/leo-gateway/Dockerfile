# Build stage
FROM node:20-alpine AS builder

WORKDIR /app

COPY package*.json ./
RUN npm ci

COPY . .

# Build TypeScript
RUN npm run build

# Production stage
FROM node:20-alpine
 
WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY --from=builder /app/dist ./dist
# Config folder is likely source code, so it compiles to dist/config. But if it's static config files... 
# In leo-gateway, config was imported from 'config'. 
# Let's check if 'config' folder exists in src or root. 
# Step 1030 showed: COPY config ./config
# If 'config' is a folder in root, we copy it.
COPY --from=builder /app/config ./config 
# Wait, if config is in root, it's not generated by build. 
# So we should copy it from context, not builder, unless builder generates it.
# Usually source code maps src/config -> dist/config.
# But here `COPY config ./config` implies a root `config` directory?
# Let's check file structure first to be sure. Assumed root config folder for now as per original dockerfile.

COPY --from=builder /app/dist ./dist

ENV NODE_ENV=production
ENV PORT=8080

EXPOSE 8080

CMD ["node", "dist/index.js"]
