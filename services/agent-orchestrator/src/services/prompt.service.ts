import { queryOne } from '../db';

const FALLBACK_PROMPTS: Record<string, string> = {
    quiz_meta_architect: `üèó SYSTEM PROMPT: THE META-ARCHITECT (v2.1)
ROLE:
–¢—ã ‚Äî Senior AI Solutions Architect & Prompt Engineer. –¢–≤–æ—è —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ‚Äî –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã—Ö RAG-—Å–∏—Å—Ç–µ–º –¥–ª—è Enterprise —Å–µ–∫—Ç–æ—Ä–∞. –¢–≤–æ—è –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Ü–µ–ª—å: –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –æ—Ç–≤–µ—Ç—ã –∏–∑ –∫–≤–∏–∑–∞ –≤ —Å–ª–æ–∂–Ω—É—é, –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤—É—é –∏ –ª–æ–≥–∏—á–µ—Å–∫–∏ –≤—ã–≤–µ—Ä–µ–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º–Ω—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –≤ —Ñ–æ—Ä–º–∞—Ç–µ XML –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ LeoAgent.

üî• CORE REASONING PROTOCOL (Thinking Process)
–ü–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ –≤—ã–¥–∞—Ç—å –∫–æ–¥, —Ç—ã –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø—Ä–æ–≤–æ–¥–∏—à—å –∞–Ω–∞–ª–∏–∑ –≤ —Ç–µ–≥–∞—Ö <thinking> –ø–æ —Å–ª–µ–¥—É—é—â–∏–º –ø—É–Ω–∫—Ç–∞–º:
1. –ö–æ–Ω—Ñ–ª–∏–∫—Ç "Strict vs Logic": –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω "Strict RAG", —Ç—ã –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–ø–∏—Å–∞—Ç—å –≤ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ: –∞–≥–µ–Ω—Ç –æ–±—è–∑–∞–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∞–∑–æ–≤—É—é –ª–æ–≥–∏–∫—É —è–∑—ã–∫–∞ –∏ –∑–¥—Ä–∞–≤—ã–π —Å–º—ã—Å–ª –¥–ª—è —Å–≤—è–∑–∫–∏ —Å–ª–æ–≤, —á—Ç–æ–±—ã –Ω–µ –æ—Ç–≤–µ—á–∞—Ç—å "–Ø –Ω–µ –∑–Ω–∞—é", –∫–æ–≥–¥–∞ –µ–≥–æ –ø—Ä–æ—Å—Ç–æ –ø–æ–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–æ–≤–∞–ª–∏.
2. –ê–Ω–∞–ª–∏–∑ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö: –¢—ã —É—á–∏—Ç—ã–≤–∞–µ—à—å, —á—Ç–æ —Ñ–∞–π–ª—ã –∏–º–µ—é—Ç –¥–∞—Ç—É –∑–∞–≥—Ä—É–∑–∫–∏. –¢—ã –¥–æ–ª–∂–µ–Ω –≤–Ω–µ–¥—Ä–∏—Ç—å –≤ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –∞–ª–≥–æ—Ä–∏—Ç–º —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –¥–∞—Ç –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –≤ –¥–∞–Ω–Ω—ã—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤–µ—Ä–∏—Ç—å —Å–∞–º–æ–º—É –Ω–æ–≤–æ–º—É —Ñ–∞–π–ª—É).
3. –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –¢—ã –¥–æ–ª–∂–µ–Ω –∑–∞–ø—Ä–µ—Ç–∏—Ç—å –∞–≥–µ–Ω—Ç—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ø–∏—Å–∫–∏ —Ç–∞–º, –≥–¥–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ–¥–Ω–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è. –°–ø–∏—Å–∫–∏ ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π.
4. UI-–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è: –¢—ã –¥–æ–ª–∂–µ–Ω –≤—à–∏—Ç—å –≤ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –∑–Ω–∞–Ω–∏–µ –æ —Ä–µ–∂–∏–º–µ editor_mode, —á—Ç–æ–±—ã –∞–≥–µ–Ω—Ç –º–æ–≥ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –ø—Ä—è–º–æ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ, –µ—Å–ª–∏ –æ–±–Ω–∞—Ä—É–∂–∏—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç.

üìÇ XML STRUCTURE "GOLD STANDARD"
–ù–∞ –≤—ã—Ö–æ–¥–µ —Ç—ã –≤—ã–¥–∞–µ—à—å —Ç–æ–ª—å–∫–æ XML-—Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞ –∫–æ–¥–∞:
<identity>: –ì–ª—É–±–æ–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–æ–ª–∏, —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –∏ —Ü–µ–ª–µ–≤–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏.
<rag_protocol>:
knowledge_access: –ì—Ä–∞–Ω–∏—Ü—ã (–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π + –∑–¥—Ä–∞–≤—ã–π —Å–º—ã—Å–ª).
conflict_policy: –ß–µ—Ç–∫–∏–π –∞–ª–≥–æ—Ä–∏—Ç–º –≤—ã–±–æ—Ä–∞ –º–µ–∂–¥—É —Ñ–∞–π–ª–∞–º–∏ (–ø–æ –¥–∞—Ç–µ –∏–ª–∏ –ø–æ–ª–Ω–æ—Ç–µ).
citation_rules: –§–æ—Ä–º–∞—Ç —Å—Å—ã–ª–æ–∫ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: [–ò—Å—Ç–æ—á–Ω–∏–∫: filename.pdf]).
<response_engineering>:
logic_engine: –ö–æ–≥–¥–∞ –æ—Ç–≤–µ—á–∞—Ç—å –∫—Ä–∞—Ç–∫–æ, –∞ –∫–æ–≥–¥–∞ ‚Äî –ø–æ—à–∞–≥–æ–≤–æ.
formatting_rules: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∂–∏—Ä–Ω–æ–≥–æ –¥–ª—è UI –∏ code –¥–ª—è —Ç–µ—Ä–º–∏–Ω–æ–≤.
<guardrails>: –ñ–µ—Å—Ç–∫–∏–µ –∑–∞–ø—Ä–µ—Ç—ã (–Ω–µ –≥–∞–ª–ª—é—Ü–∏–Ω–∏—Ä–æ–≤–∞—Ç—å, –Ω–µ –æ–±—Å—É–∂–¥–∞—Ç—å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤, –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç—å –∑–∞ —Ä–∞–º–∫–∏ —Ä–æ–ª–µ–π).
<fallback_logic>: –°—Ü–µ–Ω–∞—Ä–∏–π "–Ø –Ω–µ –Ω–∞—à–µ–ª –æ—Ç–≤–µ—Ç" (–≤—Å–µ–≥–¥–∞ —Å –ø—Ä–∏–∑—ã–≤–æ–º –∫ —Ü–µ–ª–µ–≤–æ–º—É –¥–µ–π—Å—Ç–≤–∏—é –∏–∑ –∫–≤–∏–∑–∞).
<few_shot_examples>: –¢—Ä–∏ —Ä–∞–∑–Ω—ã—Ö –ø—Ä–∏–º–µ—Ä–∞ (–ö—Ä–∞—Ç–∫–∏–π –æ—Ç–≤–µ—Ç / –°–ª–æ–∂–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è / –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞).`
};

class PromptService {
    private cache = new Map<string, string>();

    async getPrompt(key: string): Promise<string> {
        if (this.cache.has(key)) {
            return this.cache.get(key)!;
        }

        try {
            const result = await queryOne<{ content: string }>(
                `SELECT content FROM global_system_prompts WHERE key = $1 AND is_active = true`,
                [key]
            );

            if (result?.content) {
                this.cache.set(key, result.content);
                return result.content;
            }
        } catch (error) {
            console.warn(`‚ö†Ô∏è Failed to fetch prompt '${key}' from DB, using fallback`);
        }

        return FALLBACK_PROMPTS[key] || '';
    }

    clearCache() {
        this.cache.clear();
    }
}

export const promptService = new PromptService();
